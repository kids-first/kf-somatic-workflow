# Kids First DRC Amplicon Architect(AA) Workflow (WIP)
This is an extra-chromosomal DNA (ecDNA) pipeline designed to detect ecDNA candidates.
Briefly, chromosomal fragments in tumor cells make break off to form circular DNA.
This DNA acts sort of like a plasmid/mtDNA in that it is not beholden to the usual rules of cell division and can have massive copy numbers in each cell.
The tools for this pipeline were derived from https://github.com/jluebeck/AmpliconArchitect, related publication: https://www.nature.com/articles/s41467-018-08200-y

## Tools
### Dockerfiles:
 - `images.sbgenomics.com/milos_nikolic/cnvkit:0.9.3`: Optional, to create a "raw" (not .call.cns) .cns file.
 - `jluebeck/prepareaa:latest`: Contains all software required to run pre-processing and processing steps

### `tools/cnvkit_batch_only.cwl`
Modified version of somatic workflow `tools/cnvkit_batch.cwl` to truly run the batch step in a limited capacity.
Other CN callers can be used, but since KF uses this natively, but does not output `.cns` calls, it is necessary to run on legacy samples until this workflow is part of production.
#### Inputs (critical):
 - `input_sample`: tumor bam file
 - `run_mode`: enum with choices: ["wgs", "hybrid", "amplicon"], _currently AA works only with WGS_
 - `male_input_flag`: boolean, set to true if reference is male
 - `output_basename`: string
 If `.cnn` file available:
 - `cnvkit_cnn`: `.cnn` file from a previous run 
 If `.cnn` is unavailable:
 - `input_control`: input normal file
 - `reference`: fasta file and index
 - `annotation_file`: refFlat.txt file
#### Outputs (critical):
 - `output_cns`: `.cns` file needed for AA

### `tools/cns_to_aa_bed.cwl`
Converts `.cns` file to bed, adding "crude ploidy estimates".
Again, it is recommended that `.cns` be used, not `.call.cns`
#### Inputs:
 - `input_cns`: Raw `.cns` output
#### Outputs:
 - `aa_cns_bed`: Outputs two bed files. May restrict to one later once I understand better
   - `_ESTIMATED_PLOIDY_CORRECTED_CN.bed`: currently used for subsequent steps
   - `_uncorr_CN.bed`: currently not used, keep until I understand better

**Note, while the tools below can use cram input, processing is slower by about 16%**
### `tools/prepare_aa.cwl`
This tool uses the bed file regions to analyze input bam/cram file for amplicon candidates.
#### Inputs (critical):
 - `data_repo`: Reference tar ball obtained from https://datasets.genepattern.org/?prefix=data/module_support_files/AmpliconArchitect/
 - `data_ref_version`: enum, "GRCh38", "hg19", "GRCh37", "mm10", "GRCm38". Genome version in data repo to use. Should match `data_repo` downloaded.
 - `sorted_bam`: Input bam/cram
 - `sample`: Output prefix name
 - `cnv_bed`: Converted CNVkit cns-to-bed file
 - `ref_cache`: _For cram input_, provide tar ball of output of running misc/seq_cache_populate.pl from samtools on the reference fasta
#### Outputs:
 - `aa_cnv_seeds`: Bed files with seed intervals to search for viable ecDNA amplicons
 - `coverage_stats`: Coverage stats file to provide for running AA

### `tools/amplicon_architect.cwl`
This ties up all the prep work and outputs ecDNA candidates based on the seed regions provided
#### Inputs (critical):
 - `data_repo`: Reference tar ball obtained from https://datasets.genepattern.org/?prefix=data/module_support_files/AmpliconArchitect/
 - `data_ref_version`: enum, "GRCh38", "hg19", "GRCh37", "mm10", "GRCm38". Genome version in data repo to use. Should match `data_repo` downloaded.
 - `bam`: Input bam/cram
 - `downsample`: Recommended for anaylsis, recommended value be 10
 - `output_basename`: output file name prefix
 - `aa_bed`: Bed file from prepare-aa
 - `coverage_stats`: Coverage stats file generated by prepare-aa
 - `ref_cache`: _For cram input_, provide tar ball of output of running misc/seq_cache_populate.pl from samtools on the reference fasta
 - `mosek_license_file`: This tool uses some software that requires a license file. You can get a personal or institutional one from https://www.mosek.com/license/request/

